<html>
<header>
    <meta charset='utf-8'>
    <meta name='viewport' content='user-scalable=no width=device-width' />
    <title>도에이 지하철 운행 정보</title>
</header>
<style>
    body {
        margin: 0px;
        font-family: NanumGothic;
    }

    div.header {
        padding: 12px;
        color: white;
        background-color: #3A9C42;
        font-size: 22px;
        box-shadow: 1px 2px 4px 1px rgba(0, 0, 0, 0.3);
    }

    div.body {
        padding: 12px;
        margin: 0px auto;
        max-width: 768px;
    }

    div.footer {
        margin: 0px;
    }

    table {
        width: 100%;
        border: 1px solid #000000;
        border-collapse: collapse;
        margin: 0px;
    }

    td {
        width: 25%;
        border: 1px solid #000000;
        text-align: center;
        padding: 8px;
        vertical-align: middle;
    }

    tr.lines>td {
        font-size: 18px;
    }

    img {
        height: 22px;
        margin: 4px;
        vertical-align: middle;
        display: inline;
    }

    table#help {
        margin-top: 16px;
    }

    td.title {
        font-size: 20px;
        font-weight: bold;
        background-color: #C8E6C9;
    }

    td.body {
        width: 75%;
        font-size: 18px;
        text-align: start;
    }

    p {
        margin-top: 2px;
    }

    a {
        text-decoration: none;
    }

    div#map {
        padding: 8px;
    }

    line,
    polyline {
        stroke-width: 5px;
        stroke-linejoin: round;
        stroke-linecap: round;
    }

    hr {
        margin: 0px;
    }

    p.copyright {
        text-align: center;
        font-size: 14px;
    }

    @media screen and (max-width: 768px) {
        img {
            margin: 0 auto;
            display: block;
        }

        tr.lines>td {
            font-size: 14px;
        }
    }
</style>

<body>
    <link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-gothic.css" rel="stylesheet">
    <div class=header>
        도에이 지하철 실시간 운행 정보
    </div>
    <div class=body>
        <table>
            <tr class=lines>
                <td onclick='loadData("A");'><img src='./images/A.png'>아사쿠사선</td>
                <td onclick='loadData("I");'><img src='./images/I.png'>미타선</td>
                <td onclick='loadData("S");'><img src='./images/S.png'>신주쿠선</td>
                <td onclick='loadData("E");'><img src='./images/E.png'>오에도선</td>
            </tr>
        </table>

        <table id=help>
            <tr>
                <td class=title colspan=2>도움말</td>
            </tr>
            <tr>
                <td class=body colspan=2>
                    <p>&nbsp;&nbsp;위에 있는 노선 아이콘이나 이름을 누르면 해당 노선의 실시간 운행 정보를 확인할 수 있어요. 열차 위치가 자동으로 새로고침되지는 않아요.</p>
                    <p>&nbsp;&nbsp;열차 운행 정보는 <a href='https://ckan.odpt.org/en/dataset/r_train_location-toei/resource/431564fc-adf4-4b6c-8210-e82175078b3e'>일본 대중교통 오픈 데이터 센터에서 제공하는 Open API</a>를 통해 받아오고, <a href='https://hangeul.naver.com/font/nanum'>네이버에서 제공하는 나눔글꼴</a>을 사용하고 있어요.</p>
                </td>
            </tr>
            <tr>
                <td class=title colspan=2>범 례</td>
            </tr>
            <tr>
                <td><img src='./images/train_up_0.png'>&nbsp;&nbsp;&nbsp;<img src='./images/train_dn_0.png'></td>
                <td class=body>보통 열차</td>
            </tr>
            <tr>
                <td><img src='./images/train_up_1.png'>&nbsp;&nbsp;&nbsp;<img src='./images/train_dn_1.png'></td>
                <td class=body>쾌속, 특급, 급행 열차 등</td>
            </tr>
        </table>
        <div id='map'>
        </div>
        <hr>
    </div>
    <div class=footer>
        <p class=copyright>© 2023 Dark Tornado, All rights reserved.</p>
    </div>
    <script>
        function loadData(lineCode) {
            fetch('https://api.darktornado.net/subway/jp/toei?line=' + lineCode)
                .then((response) => response.json())
                .then((data) => {
                    createMap(data, lineCode);
                });
        }

        function createMap(data, lineCode) {
            document.getElementById('help').style.display = 'none';
            if (lineCode == 'E') return createOedoLine(data);
            var m = 100;
            var height = m * data.length;
            var color = {
                'A': '#FF535F',
                'I': '#0067B0',
                'S': '#9FB01C'
                // 'E': '#CF3366'
            };
            var src = '<svg viewbox="0 0 600 ' + height + '" >';
            src += '<line x1="50" y1="10" x2="50" y2="' + (height - 10) + '" stroke="' + color[lineCode] + '" />';
            data.forEach((e, i) => {
                src += text(100, m * i + m / 2, e.stn, '#000000', 30);
                src += train(30, m * i + m / 2, e.up, 'up');
                src += train(70, m * i + m / 2, e.dn, 'dn');
            });
            document.getElementById('map').innerHTML = src;
        }

        function createOedoLine(data) {
            var m = 100;
            var height = m * data.length;
            var src = '<svg viewbox="0 0 600 2520" >';
            src += '<polyline points="50,10 50,2490 60,2500 540,2500 550,2490 550,1100 540,1090 160,1090 150,1080 150,1020" fill="none" stroke="#CF3366" />';
            for (var n = 1; n < 14; n++) {
                var y = m * n + m + m * 10;
                src += text(500, y, data[n].stn, '#000000', 24, 'end');
                src += train(520, y, data[n].up, 'up');
                src += train(580, y, data[n].dn, 'dn');
            }
            for (var n = 14; n < 28; n++) {
                var y = m * data.length - (m * n + m / 2);
                src += text(100, y, data[n].stn, '#000000', 24);
                src += train(70, y, data[n].up, 'dn');
                src += train(30, y, data[n].dn, 'up');
            }
            var n = 28;
            var y = m * data.length - (m * n + m / 2);
            src += text(200, y, data[n].stn, '#000000', 30);
            src += train(70, y, data[n].up, 'dn');
            src += train(30, y, data[n].dn, 'up');
            src += train(170, y, data[0].up, 'dn');
            src += train(130, y, data[0].dn, 'up');
            for (var n = 29; n < data.length; n++) {
                var y = m * data.length - (m * n + m / 2);
                src += text(100, y, data[n].stn, '#000000', 30);
                src += train(70, y, data[n].up, 'dn');
                src += train(30, y, data[n].dn, 'up');
            }
            document.getElementById('map').innerHTML = src;
        }

        function text(x, y, stn, color, size, align) {
            if (align == undefined) align = 'start';
            var style = '"';
            style += 'font-size: ' + size + 'px;'
            style += 'text-anchor: ' + align + ';'
            style += '"';
            return '<text style=' + style + ' x=' + x + ' y=' + y + ' fill=' + color + '\'>' + stn + '</text>';
        }

        function train(x, y, data, updn) {
            if (data.length == 0) return '';
            x -= 10;
            y -= 30;
            var file = "images/train_" + updn + "_" + (data[0].type == '보통' ? 0 : 1) + ".png";
            return "<image xlink:href='" + file + "' x='" + x + "' y='" + y + "' width='20px'/>";
        }
    </script>
</body>

</html>